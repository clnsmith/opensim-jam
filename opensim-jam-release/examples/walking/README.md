# Example: Walking

## Simulation Description
<p align="center">
  <b>COMAK Workflow</b><br>
  <img src="../../documentation/figures/comak/comak_workflow.png" height="400" > 
</p>

<p align="center">
  <b>COMAK Algorithm</b><br>
  <img src="../../documentation/figures/comak/comak_algorithm.png" height="400" >
  <br><i>Note: The complete form of the cost function is provided below. </i><br>
</p>

This example uses the COMAK to predict muscle forces, ligament forces, cartilage contact pressures, and secondary knee kinematics (5 tibiofemoral DOFs, 5 patellofemoral DOFs) during walking. 

The experimental data (motion capture, ground reaction forces) were collected while the Lenhart2015 subject performed overground walking at a self selected speed. 

Within COMAK it is important to define model coordinates as Primary, Secondary, and Prescribed. The Primary and the Prescribed coordinates must be quantifable using motion capture. In the COMAK optimization, a constraint equation is included for each Primary coordinate that dictates that the simulated accelerations (resulting from the model muscle, ligament, contact, external, gravitational, inertial forces) are equal to the measured accelerations of the Primary coordinates. In simpler terms, the model must generate the measured joint moments for the Primary coordinates. The Prescribed coordinates are prescribed within the simulation, thus their accelerations are generated by multibody constraints and not by the model forces. The Secondary coordinates generally cannot be accurately measured using motion capture and thus are predicted by the COMAK optimization.     

__Primary Coordinates__
- hip_flex_r
- hip_add_r
- hip_rotation_r
- knee_flex_r
- ankle_flex_r

__Secondary Coordinates__
- knee_add_r
- knee_rot_r
- knee_tx_r
- knee_ty_r
- knee_tz_r
- pf_flex_r
- pf_rot_r
- pf_tilt_r
- pf_tx_r
- pf_ty_r
- pf_tz_r

__Prescribed Coordinates__
- All other model coordinates (pelvis, left leg, upperbody). 

__COMAKInverseKinematicsTool__

The COMAKInverseKinematicsTool is used to calculate the kinematics of the Primary and Prescribed coordinates from the motion capture data. First, the COMAKInverseKinematics tool is used to perform a passive forward simulation where the knee flexion flexes from 0<sup>o</sup> to 120<sup>o</sup> and the Seconday coordinates are predicted based on the passive muscle, ligament, and articular contact forces. These simulation results are used to generate functions that couple the Secondary coordinates to the knee_flex_r within inverse kinematics through a CoordinateCouplerConstraint. These constraints are only used in the inverse kinematics solution and are removed for the COMAK simulation.
  
__COMAKTool__

The COMAKTool is used to calculate the Secondary kinematics, as well as the muscle, ligament, and articular contact forces for the measured walking trial. The COMAK optimization minimizes the following cost function:
<p align="center">
  <b>COMAK Cost Function</b><br>
  <img src="../../documentation/figures/comak/comak_cost_function.png" height="200" > 
</p>

In this example, three simulations are performed with different cost function parameters using the same input data to demonstrate the ability to vary the optimized muscle coordination patterns and inspect the resulting knee mechanics. The three simulations are setup as follows

_comak_\
All muscle weight terms (W<sub>i</sub>) are set to 1, and the contact energy weight (CW) is set to 0.

_comak_muscle_weights_\
All muscle weight terms (W<sub>i</sub>) are set to 1 except those listed below, and the contact energy weight (CW) is set to 0.
- W<sub>gasmed_r</sub> = 4
- W<sub>gaslat_r</sub> = 7
- W<sub>gaslat_r</sub> = 7
- W<sub>soleus_r</sub> = 0.9
- W<sub>recfem_r</sub> = 3
- W<sub>glmed1_r</sub> = 0.9
- W<sub>glmed2_r</sub> = 0.9
- W<sub>glmed3_r</sub> = 0.9
- W<sub>glmin1_r</sub> = 0.9
- W<sub>glmin2_r</sub> = 0.9
- W<sub>glmin3_r</sub> = 0.9
- W<sub>bflh_r</sub> = 2
- W<sub>bfsh_r</sub> = 2
- W<sub>semiten_r</sub> = 2
- W<sub>semimem_r</sub> = 2


_comak_contact_energy_\
All muscle weight terms (W<sub>i</sub>) are set to 1, and the contact energy weight (CW) is set to 500.
## Simulation Results
<p align="center">
  <b>Tibiofemoral Kinematics</b><br>
  <img src="graphics/walking_tibiofemoral_kinematics.png" height="400" >  
</p>

<p align="center">
  <b>Patellofemoral Kinematics</b><br>
  <img src="graphics/walking_patellofemoral_kinematics.png" height="400" > 
</p>

<p align="center">
  <b>Tibia Axial Contact Force</b><br>
  <img src="graphics/walking_knee_contact_force.png" height="400" > 
</p>

<p align="center">
  <b>Muscle Activations</b><br>
  <img src="graphics/walking_muscle_activations.png" height="250" > 
</p>

<p align="center">
  <b>Cartilage Contact Pressure</b><br>
  <img src="graphics/walking_contact.gif" height="400" > 
</p>

<p align="center">
  <b>ACL and Patellar Tendon Force</b><br>
  <img src="graphics/walking_ligaments.gif" height="400" > 
</p>

## Workflow Steps
1) Inspect the [./inputs/comak_inverse_kinematics_settings.xml](./inputs/comak_inverse_kinematics_settings.xml), as well as the [./inputs/comak_settings.xml](./inputs/comak_settings.xml), [./inputs/comak_settings_muscle_weights.xml](./inputs/comak_settings_muscle_weights.xml), and [./inputs/comak_settings_contact_energy.xml](./inputs/comak_settings_contact_energy.xml) files to understand the inputs and settings for the simulation.

2) Double click on [run_walking.cmd](run_walking.cmd) to run the COMAKInverseKinematics, COMAKTool, and JointMechanicsTools to perform the simulation using the command line. You can open this file in a text editor to understand the code format to run the executables. 

4) Use Paraview and/or the OpenSim GUI to visualize the simulation results [instructions](../../documentation/visualizing-models-and-simulation-results.md).

5) Use MATLAB to run [./analysis/generate_walking_results_plots.m](./analysis/generate_walking_results_plots.m) to generate plots of the simulation results. 
